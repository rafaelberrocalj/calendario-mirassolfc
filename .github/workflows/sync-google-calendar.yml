name: ğŸ“… Sincronizar Google Calendar

on:
  schedule:
    # Executar diariamente Ã s 00:00 UTC (22:00 BRT anterior)
    - cron: '0 0 * * *'
  
  # Permitir execuÃ§Ã£o manual via GitHub UI
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-calendar:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Executar Scraper
        run: |
          python3 scraper.py
          echo "âœ… Scraper executado com sucesso"
      
      - name: ğŸ” Configurar Service Account (GitHub Secret)
        env:
          SERVICE_ACCOUNT_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$SERVICE_ACCOUNT_KEY" > service-account.json
          echo "âœ… Service Account key written"

      - name: ğŸ“± Sincronizar com Google Calendar
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service-account.json
          SERVICE_ACCOUNT_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY }}
        run: |
          python3 google_calendar_sync.py
          echo "âœ… CalendÃ¡rio sincronizado"
      
      - name: ğŸ§¹ Limpar credenciais
        if: always()
        run: |
          rm -f service-account.json
          echo "âœ… Credenciais removidas (seguranÃ§a)"
      
      - name: ğŸ“ Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: ğŸ“¤ Fazer commit de mudanÃ§as
        run: |
          git add mirassol_futebol_clube.ics || true
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ Nenhuma mudanÃ§a no .ics"
          else
            git commit -m "ğŸ“… AtualizaÃ§Ã£o automÃ¡tica do calendÃ¡rio [skip ci]"
            echo "âœ… Commit realizado"
          fi
      
      - name: ğŸš€ Push para repositÃ³rio
        run: |
          git push || echo "Nada para fazer push"
          echo "âœ… Push concluÃ­do"
      
      - name: âœ¨ Sucesso!
        run: |
          echo "ğŸ‰ SincronizaÃ§Ã£o completa!"
          echo "âœ… Scraper executado"
          echo "âœ… CalendÃ¡rio sincronizado"
          echo "âœ… MudanÃ§as enviadas"
